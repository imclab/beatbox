var app=app||{};app.views={},app.models={},app.collections={},app.templates={},app.config={},navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,this.app=this.app||{},this.app.templates=this.app.templates||{},this.app.templates.controls=function(e,t,n,r,i){return n=n||e.helpers,'<div class="controls-view">\n  <select class="kit-select">\n    <option value="rock">Rock Kit</option>\n    <option value="hiphop">Hip-hop Kit</option>\n    <option value="insane">Insane Kit</option>\n  </select>\n</div>\n'},this.app.templates.intro=function(e,t,n,r,i){return n=n||e.helpers,"<div>\n  This is how this works.\n</div>\n"},this.app.templates.video=function(e,t,n,r,i){return n=n||e.helpers,'<video id="video" autoplay="true"></video>\n<canvas id="canvas"></canvas>\n'},function(){app.models.AudioInput=Backbone.Model.extend({KICK:{low:0,high:500},SNARE:{low:1e3,high:5e3},THRESHOLD:.15,BUFFER_SIZE:1024,DECAY:.12,initialize:function(){var e=this;this.context=this.get("context"),this.wait=0,navigator.webkitGetUserMedia({audio:!0},function(t){e.fft=new FFT(e.BUFFER_SIZE,e.context.sampleRate),e.sourceNode=e.context.createMediaStreamSource(t),e.procNode=e.context.createJavaScriptNode(e.BUFFER_SIZE,1,1),e.sourceNode.connect(e.procNode),e.procNode.onaudioprocess=function(t){e.processAudio.call(e,t)},e.procNode.connect(e.context.destination)})},processAudio:function(e){this.wait-=this.DECAY,this.fft.forward(e.inputBuffer.getChannelData(0)),this.detectSound(this.fft.spectrum)},detectSound:function(e){var t;if(this.wait>0)return;t=this.spectralCentroid(e),t>0&&console.log("Centroid: "+t),t>=this.KICK.low&&t<=this.KICK.high?(this.wait=1,this.trigger("kick")):t>=this.SNARE.low&&t<=this.SNARE.high&&(this.wait=1,this.trigger("snare"))},spectralCentroid:function(e){var t,n,r=0,i=0;for(var s=0;s<e.length;s++)t=Math.abs(e[s])<this.THRESHOLD?0:e[s],n=this.nToFreq(s,this.context.sampleRate),r+=n*t,i+=t;return r/i},preCalcNToF:function(e){var t=[];for(var n=0;n<this.BUFFER_SIZE;n++)t=this.nToFreq(n,e);return t},nToFreq:function(e,t){return e*t/this.BUFFER_SIZE}})}(),function(){app.models.Effect=Backbone.Model.extend({initialize:function(){this.node=this.get("node")},connect:function(e){this.node.connect(e.node)}})}(),function(){app.models.Sample=Backbone.Model.extend({PATH_ROOT:"audio/",initialize:function(){this.samplePath=this.get("samplePath"),this.audioInput=this.get("audioInput"),this.context=this.get("context"),this.triggerName=this.get("triggerName"),this.destination=this.get("destination"),this.loadSample(),this.audioInput.on(this.triggerName,this.play,this)},setKit:function(e){this.setSample(e+"_"+this.triggerName+".wav")},setSample:function(e){this.samplePath=e,this.loadSample()},loadSample:function(){var e=this;allen.getBuffer(this.PATH_ROOT+this.samplePath,function(t){e.buffer=e.context.createBuffer(t.target.response,!1),e.trigger("loaded")})},play:function(){console.log("playing "+this.triggerName),this.bufferNode=this.context.createBufferSource(),this.bufferNode.buffer=this.buffer,this.bufferNode.connect(this.destination),this.bufferNode.noteOn(0)}})}(),function(){app.models.VideoInput=Backbone.Model.extend({REFRESH_RATE:250,initialize:function(){var e=this;this.canvasEl=this.get("canvas"),this.height=this.canvasEl.height,this.width=this.canvasEl.width,this.videoEl=this.get("video"),this.context=this.canvasEl.getContext("2d"),this.totalArea=this.height*this.width,this.tracker=new HT.Tracker({fast:!1}),navigator.getUserMedia({video:!0},function(t){e.videoReady.call(e,t)})},videoReady:function(e){var t=this,n;this.videoEl.src=window.webkitURL.createObjectURL(e),setInterval(function(){t.videoEl.readyState===t.videoEl.HAVE_ENOUGH_DATA&&(t.context.drawImage(t.videoEl,0,0,t.width,t.height),n=t.context.getImageData(0,0,t.width,t.height),t.processVideoFrame(t.tracker.detect(n)))},this.REFRESH_RATE)},processVideoFrame:function(e){var t="red",n,r,i,s,o,u,a=0,f,l,c=this.context;if(e){o=e.hull,u=o.length;if(u){c.beginPath(),c.strokeStyle=t,c.moveTo(o[0].x,o[0].y);for(;a<u;++a)c.lineTo(o[a].x,o[a].y);c.stroke(),c.closePath()}f=o[0].x,l=o[0].y,a=1;for(;a<u;++a)f+=o[a].x,l+=o[a].y;i=this.calcHandPosition(f/u,l/u)}},calcHandPosition:function(e,t){var n={x:e,y:t};return this.trigger("position",n),n}})}(),function(){app.views.View=Backbone.View.extend({render:function(){this.template=this.template||Handlebars.template(app.templates[this.name]);var e=this.getRenderData?this.getRenderData():{};return this.$el.html(this.template(e)),console.log(this.$el.html()),this}})}(),function(){app.views.Controls=app.views.View.extend({name:"controls",className:"controls-view",events:{"change .kit-select":"handleKitSelect"},initialize:function(e){this.samples=e.samples},setKit:function(e){_.each(this.samples,function(t){t.setKit(e)})},handleKitSelect:function(e){this.setKit($(e.target).val())}})}(),function(){app.views.Intro=app.views.View.extend({name:"intro",className:"intro-view",initialize:function(e){}})}(),function(){app.views.Video=app.views.View.extend({name:"video",className:"video-view",initialize:function(e){}})}(),app.init=function(){app.introView=new app.views.Intro,app.videoView=new app.views.Video,$("#content").append(app.introView.render().$el).append(app.videoView.render().$el),app.context=allen.getAudioContext(),app.audioInput=new app.models.AudioInput({context:app.context}),app.videoInput=new app.models.VideoInput({canvas:document.getElementsByTagName("canvas")[0],video:document.getElementsByTagName("video")[0]}),app.sampleDestination=app.context.createGainNode(),app.snareSample=new app.models.Sample({context:app.context,destination:app.sampleDestination,audioInput:app.audioInput,samplePath:"rock_snare.wav",triggerName:"snare"}),app.kickSample=new app.models.Sample({context:app.context,destination:app.sampleDestination,audioInput:app.audioInput,samplePath:"rock_kick.wav",triggerName:"kick"}),app.controlsView=new app.views.Controls({samples:[app.snareSample,app.kickSample]}),$("#content").prepend(app.controlsView.render().$el);var e=app.context.createDynamicsCompressor(),t=app.context.createBiquadFilter(),n=new SimpleReverb(app.context,{decay:10,seconds:3}),r=app.context.createGain();t.frequency.value=22100,t.type.value=1,t.Q.value=4,e.threshold.value=-6,e.knee.value=10,e.ratio.value=15,e.attack.value=.003,e.release.value=.5,r.gain.value=.6,app.compressor=new app.models.Effect({node:e}),app.filter=new app.models.Effect({node:t});var i=document.getElementsByTagName("canvas")[0].height;app.videoInput.on("position",function(e){var t=e.y/i*5e3+20;app.filter.node.frequency.value=t}),app.sampleDestination.connect(app.filter.node),app.filter.connect(app.compressor),app.compressor.node.connect(n.input),app.compressor.node.connect(app.context.destination),n.connect(r),r.connect(app.context.destination),setInterval(function(){},100)},$(function(){app.init.call(app)});